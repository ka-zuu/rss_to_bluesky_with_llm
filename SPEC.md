# Bluesky RSS自動投稿スクリプト仕様書

## 1. 概要
このスクリプトは、指定されたRSSフィードから新しい記事を自動的に取得し、Gemini APIを使用して内容を評価・要約した後、最も重要と判断された記事をBlueskyに投稿するものです。

## 2. システム要件
- **OS:** Ubuntu Server (または互換性のあるLinuxディストリビューション)
- **プログラミング言語:** Python 3.x
- **ライブラリ:** `feedparser`, `google-generativeai`, `atproto`, `python-dotenv`, `beautifulsoup4`, `requests`, `grapheme`
- **外部サービス:**
    - Gemini APIキー
    - Blueskyアカウント情報（ハンドル名、アプリパスワード）
- **環境変数:** `.env`ファイルにRSSフィードのURL、APIキー、アカウント情報を設定する必要があります。

## 3. 処理フロー
1.  **定期実行:** cronジョブなどを利用して定期的に`main.py`を実行します。
2.  **データベースの初期化:** ローカルのSQLiteデータベース（`rss_cache.db`）を初期化します。このデータベースは、処理済みの記事URLを保存し、重複投稿を防ぐために使用されます。
3.  **RSSフィードの取得と記事内容のスクレイピング:**
    - `.env`ファイルからRSSフィードURLのリストを読み込みます。
    - 各フィードから記事を取得し、データベースと照合して新しい記事のみを抽出します。
    - 新しい各記事について、URLにアクセスして記事の全文をスクレイピングします。
4.  **処理対象の絞り込み:**
    - 新しい記事が多数（20件超）見つかった場合、処理負荷を考慮し、最新の20件のみを処理対象とします。
5.  **Gemini APIによる重要度評価:**
    - 処理対象の記事リスト（タイトルとURL）をGemini APIに送信します。
    - 「重要度が高い順にリスト化して」という指示に基づき、AIが記事のランキングを生成します。
6.  **最重要記事の選定:**
    - ランク付けされたリストの中から、最も重要度の高い記事（1位の記事）のみを選定します。
7.  **Gemini APIによる要約:**
    - 選定した最重要記事の本文（スクレイピング済み）をGemini APIに送信します。
    - 記事の内容を300書記素程度で簡潔に要約させます。
8.  **Blueskyへの投稿:**
    - 要約した内容と記事タイトルを含む投稿テキストを生成します。
    - 記事のURL、タイトル、要約を含むリッチな外部リンクカード（Embed Card）を作成します。
    - 生成したテキストと外部リンクカードをBlueskyに1件の投稿として送信します。
9.  **データベースの更新:**
    - Blueskyへの投稿が成功した場合、ステップ3で取得した**すべての新しい記事**のURLをデータベースに保存します。これにより、今回ランク外だった記事も次回以降の処理対象から除外されます。

## 4. 主要な関数/モジュール
- `main.py`: 全体の処理フローを制御するメインスクリプト。
- `rss_fetcher.py`: RSSフィードの取得、データベースとの重複チェック、および各記事URLからの本文スクレイピングを担当します。
- `gemini_processor.py`: Gemini APIと連携し、記事リストのランク付けと、単一記事の要約生成を担当します。
- `bluesky_poster.py`: Blueskyへの認証と投稿（テキストと外部リンクカードを含む）処理を担当します。
- `db_manager.py`: SQLiteデータベースの初期化、URLの存在チェック、および新規URLの追加を担当します。